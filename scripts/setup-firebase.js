#!/usr/bin/env node
/**
 * Script t·ª± ƒë·ªông c·∫•u h√¨nh Firebase
 * Ch·∫°y: node scripts/setup-firebase.js
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

const question = (query) => new Promise((resolve) => rl.question(query, resolve));

const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  red: '\x1b[31m'
};

const log = {
  info: (msg) => console.log(`${colors.blue}‚Ñπ${colors.reset} ${msg}`),
  success: (msg) => console.log(`${colors.green}‚úì${colors.reset} ${msg}`),
  warning: (msg) => console.log(`${colors.yellow}‚ö†${colors.reset} ${msg}`),
  error: (msg) => console.log(`${colors.red}‚úó${colors.reset} ${msg}`),
  title: (msg) => console.log(`\n${colors.bright}${msg}${colors.reset}\n`)
};

async function main() {
  log.title('üî• FIREBASE SETUP - C·∫•u h√¨nh t·ª± ƒë·ªông');

  console.log('Script n√†y s·∫Ω gi√∫p b·∫°n c·∫•u h√¨nh Firebase cho d·ª± √°n.\n');

  // B∆∞·ªõc 1: L·∫•y Firebase Config
  log.title('üìã B∆Ø·ªöC 1: L·∫•y Firebase Configuration');
  console.log('Truy c·∫≠p: https://console.firebase.google.com/');
  console.log('1. T·∫°o project m·ªõi ho·∫∑c ch·ªçn project c√≥ s·∫µn');
  console.log('2. V√†o Project Settings > General > Your apps > Web app');
  console.log('3. Copy c√°c gi√° tr·ªã firebaseConfig\n');

  const apiKey = await question('API Key: ');
  const authDomain = await question('Auth Domain (v√≠ d·ª•: your-project.firebaseapp.com): ');
  const projectId = await question('Project ID: ');
  const storageBucket = await question('Storage Bucket (v√≠ d·ª•: your-project.appspot.com): ');
  const messagingSenderId = await question('Messaging Sender ID: ');
  const appId = await question('App ID: ');

  // B∆∞·ªõc 2: C·∫•u h√¨nh Office Location
  log.title('üìç B∆Ø·ªöC 2: C·∫•u h√¨nh v·ªã tr√≠ vƒÉn ph√≤ng');
  console.log('L·∫•y t·ªça ƒë·ªô t·ª´ Google Maps (click ph·∫£i > t·ªça ƒë·ªô)\n');

  const lat = await question('Vƒ© ƒë·ªô (Latitude) [10.8231]: ') || '10.8231';
  const lng = await question('Kinh ƒë·ªô (Longitude) [106.6297]: ') || '106.6297';
  const radius = await question('B√°n k√≠nh cho ph√©p (m√©t) [100]: ') || '100';

  // B∆∞·ªõc 3: C·∫•u h√¨nh gi·ªù l√†m vi·ªác
  log.title('‚è∞ B∆Ø·ªöC 3: C·∫•u h√¨nh gi·ªù l√†m vi·ªác');

  const startHour = await question('Gi·ªù v√†o l√†m - Gi·ªù [8]: ') || '8';
  const startMinute = await question('Gi·ªù v√†o l√†m - Ph√∫t [30]: ') || '30';
  const endHour = await question('Gi·ªù tan l√†m - Gi·ªù [17]: ') || '17';
  const endMinute = await question('Gi·ªù tan l√†m - Ph√∫t [30]: ') || '30';
  const lateThreshold = await question('Ng∆∞·ª°ng tr·ªÖ (ph√∫t) [15]: ') || '15';
  const earlyThreshold = await question('Ng∆∞·ª°ng v·ªÅ s·ªõm (ph√∫t) [15]: ') || '15';

  // T·∫°o n·ªôi dung file config
  const configContent = `// src/constants/config.js
// C·∫•u h√¨nh ·ª©ng d·ª•ng
// Auto-generated by setup-firebase.js on ${new Date().toLocaleString('vi-VN')}

export const FIREBASE_CONFIG = {
  apiKey: "${apiKey}",
  authDomain: "${authDomain}",
  projectId: "${projectId}",
  storageBucket: "${storageBucket}",
  messagingSenderId: "${messagingSenderId}",
  appId: "${appId}"
};

// V·ªã tr√≠ vƒÉn ph√≤ng
export const OFFICE_LOCATION = {
  lat: ${parseFloat(lat)},      // Vƒ© ƒë·ªô vƒÉn ph√≤ng
  lng: ${parseFloat(lng)},     // Kinh ƒë·ªô vƒÉn ph√≤ng
  radius: ${parseInt(radius)}        // B√°n k√≠nh cho ph√©p (m√©t)
};

// Gi·ªù l√†m vi·ªác
export const WORKING_HOURS = {
  start: { hour: ${parseInt(startHour)}, minute: ${parseInt(startMinute)} },   // ${startHour}:${startMinute}
  end: { hour: ${parseInt(endHour)}, minute: ${parseInt(endMinute)} },    // ${endHour}:${endMinute}
  lateThreshold: ${parseInt(lateThreshold)},                 // Tr·ªÖ sau ${lateThreshold} ph√∫t
  earlyThreshold: ${parseInt(earlyThreshold)}                 // V·ªÅ s·ªõm tr∆∞·ªõc ${earlyThreshold} ph√∫t
};

// App config
export const APP_CONFIG = {
  appName: 'H·ªá th·ªëng Ch·∫•m c√¥ng GPS & QR Code',
  version: '2.1.0',
  maxDevicesPerUser: 2,
  qrCodeExpiryDays: 30
};
`;

  // Ghi file
  const configPath = path.join(__dirname, '../src/constants/config.js');

  log.title('üíæ ƒêang l∆∞u c·∫•u h√¨nh...');

  try {
    // Backup file c≈© n·∫øu c√≥
    if (fs.existsSync(configPath)) {
      const backupPath = `${configPath}.backup.${Date.now()}`;
      fs.copyFileSync(configPath, backupPath);
      log.info(`ƒê√£ backup file c≈©: ${path.basename(backupPath)}`);
    }

    // Ghi file m·ªõi
    fs.writeFileSync(configPath, configContent, 'utf8');
    log.success('ƒê√£ l∆∞u: src/constants/config.js');

    // T·∫°o .env.local n·∫øu ch∆∞a c√≥
    const envPath = path.join(__dirname, '../.env.local');
    if (!fs.existsSync(envPath)) {
      const envContent = `# Firebase Configuration
REACT_APP_FIREBASE_API_KEY=${apiKey}
REACT_APP_FIREBASE_AUTH_DOMAIN=${authDomain}
REACT_APP_FIREBASE_PROJECT_ID=${projectId}
REACT_APP_FIREBASE_STORAGE_BUCKET=${storageBucket}
REACT_APP_FIREBASE_MESSAGING_SENDER_ID=${messagingSenderId}
REACT_APP_FIREBASE_APP_ID=${appId}

# Office Location
REACT_APP_OFFICE_LAT=${lat}
REACT_APP_OFFICE_LNG=${lng}
REACT_APP_OFFICE_RADIUS=${radius}
`;
      fs.writeFileSync(envPath, envContent, 'utf8');
      log.success('ƒê√£ t·∫°o: .env.local');
    }

    // Hi·ªÉn th·ªã t√≥m t·∫Øt
    log.title('üìä T√ìM T·∫ÆT C·∫§U H√åNH');
    console.log(`Firebase Project: ${colors.bright}${projectId}${colors.reset}`);
    console.log(`VƒÉn ph√≤ng: ${colors.bright}${lat}, ${lng}${colors.reset} (b√°n k√≠nh ${radius}m)`);
    console.log(`Gi·ªù l√†m: ${colors.bright}${startHour}:${startMinute} - ${endHour}:${endMinute}${colors.reset}`);

    log.title('‚úÖ HO√ÄN TH√ÄNH!');
    console.log('C√°c b∆∞·ªõc ti·∫øp theo:');
    console.log('1. Ch·∫°y: npm run firebase:init - ƒê·ªÉ kh·ªüi t·∫°o Firestore collections');
    console.log('2. Ch·∫°y: npm run firebase:deploy - ƒê·ªÉ deploy security rules');
    console.log('3. Ch·∫°y: npm start - ƒê·ªÉ start ·ª©ng d·ª•ng\n');

    log.warning('L∆ØU √ù: B·∫°n v·∫´n c·∫ßn enable Authentication v√† t·∫°o Firestore Database tr√™n Firebase Console!');
    console.log('Xem h∆∞·ªõng d·∫´n chi ti·∫øt t·∫°i: docs/FIREBASE-SETUP.md\n');

  } catch (error) {
    log.error(`L·ªói: ${error.message}`);
    process.exit(1);
  }

  rl.close();
}

main().catch(console.error);
